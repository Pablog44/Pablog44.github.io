<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Marcas en el Gimnasio</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js"></script>
</head>
<body>
    <header>
        <h1>Registro de Marcas en el Gimnasio</h1>
    </header>
    <main>
        <section id="form-section">
            <div class="form-container">
                <label for="muscle-group">Grupo Muscular:</label>
                <select id="muscle-group"></select>
                <label for="exercise">Ejercicio:</label>
                <select id="exercise"></select>
                <label for="weight">Peso (kg):</label>
                <input type="number" id="weight" min="0" step="1">
                <label for="repetitions">Repeticiones:</label>
                <input type="number" id="repetitions" min="0" step="1">
                <label for="exercise-date">Fecha:</label>
                <input type="datetime-local" id="exercise-date">
                <button id="save-exercise">Guardar Ejercicio</button>
            </div>
        </section>
        <section id="custom-section">
            <div class="form-container">
                <h2>Añadir Nuevos Grupos/Ejercicios</h2>
                <label for="new-muscle-group">Nuevo Grupo Muscular:</label>
                <input type="text" id="new-muscle-group">
                <button id="add-muscle-group">Añadir Grupo Muscular</button>
                <label for="new-exercise">Nuevo Ejercicio:</label>
                <input type="text" id="new-exercise">
                <select id="select-muscle-group"></select> <label for="select-muscle-group">Selecciona Grupo Muscular:</label>
                <button id="add-exercise">Añadir Ejercicio</button>
            </div>
        </section>
        <section id="records-section">
            <h2>Historial de Ejercicios</h2>
            <ul id="exercise-records"></ul>
        </section>
    </main>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, setDoc, query, orderBy, deleteDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

        const firebaseConfig = {
            // ... tu configuración de Firebase
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const muscleGroupSelect = document.getElementById("muscle-group");
        const exerciseSelect = document.getElementById("exercise");
        const weightInput = document.getElementById("weight");
        const repetitionsInput = document.getElementById("repetitions");
        const exerciseDateInput = document.getElementById("exercise-date");
        const saveExerciseButton = document.getElementById("save-exercise");
        const newMuscleGroupInput = document.getElementById("new-muscle-group");
        const addMuscleGroupButton = document.getElementById("add-muscle-group");
        const newExerciseInput = document.getElementById("new-exercise");
        const selectMuscleGroup = document.getElementById("select-muscle-group");
        const addExerciseButton = document.getElementById("add-exercise");
        const exerciseRecordsList = document.getElementById("exercise-records");

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'inicio.html';
            } else {
                initializeMuscleGroups();
                displayExerciseRecords();
            }
        });

        function initializeMuscleGroups() {
            const muscleGroupsRef = collection(db, "muscleGroups");
            getDocs(muscleGroupsRef).then(snapshot => {
                if (snapshot.empty) {
                    console.log("No muscle groups found, initializing default groups.");
                    initializeDefaultMuscleGroups(muscleGroupsRef);
                } else {
                    snapshot.forEach(doc => {
                        const option = document.createElement("option");
                        option.textContent = doc.id;
                        option.value = doc.id;
                        muscleGroupSelect.appendChild(option);
                        selectMuscleGroup.appendChild(option.cloneNode(true)); // Clonar la opción para el segundo select
                    });
                    updateExerciseOptions();
                }
            }).catch(error => {
                console.error("Error loading muscle groups:", error);
            });
        }

        function initializeDefaultMuscleGroups(muscleGroupsRef) {
            const initialGroups = {
                Pecho: ['Press Banca', 'Press Inclinado', 'Aperturas'],
                Espalda: ['Dominadas', 'Remo con Barra', 'Jalón al Pecho'],
                Brazos: ['Curl con Barra', 'Tríceps Fondo', 'Martillo'],
                Piernas: ['Sentadilla', 'Prensa', 'Peso Muerto'],
                Hombros: ['Press Militar', 'Elevaciones Laterales', 'Pájaro']
            };
            Object.keys(initialGroups).forEach(group => {
                setDoc(doc(muscleGroupsRef, group), { exercises: initialGroups[group] });
            });
        }

        function updateExerciseOptions() {
            const selectedGroup = muscleGroupSelect.value;
            const groupRef = doc(db, "muscleGroups", selectedGroup);
            getDoc(groupRef).then(doc => {
                if (doc.exists()) {
                    const data = doc.data();
                    exerciseSelect.innerHTML = ''; 
                    data.exercises.forEach(exercise => {
                        const option = document.createElement("option");
                        option.value = exercise;
                        option.textContent = exercise;
                        exerciseSelect.appendChild(option);
                    });
                }
            }).catch(error => {
                console.error("Error loading exercises:", error);
            });
        }

        function saveExercise() {
            // ... (código para guardar ejercicio)
        }

        function displayExerciseRecords() {
            // ... (código para mostrar historial)
        }

        function deleteRecord(docId) {
            // ... (código para eliminar registro)
        }

        function clearForm() {
            // ... (código para limpiar formulario)
        }

        function addMuscleGroup() {
            const newGroup = newMuscleGroupInput.value;
            if (newGroup) {
                setDoc(doc(collection(db, "muscleGroups"), newGroup), { exercises: [] })
                    .then(() => {
                        // Actualizar los desplegables de grupos musculares
                        const option = document.createElement("option");
                        option.textContent = newGroup;
                        option.value = newGroup;
                        muscleGroupSelect.appendChild(option);
                        selectMuscleGroup.appendChild(option.cloneNode(true));

                        newMuscleGroupInput.value = '';
                    })
                    .catch(error => {
                        console.error("Error adding muscle group:", error);
                    });
            }
        }

        function addExercise() {
            const newExercise = newExerciseInput.value;
            const selectedGroup = selectMuscleGroup.value;

            if (newExercise && selectedGroup) {
                const groupRef = doc(db, "muscleGroups", selectedGroup);
                updateDoc(groupRef, {
                    exercises: arrayUnion(newExercise)
                }).then(() => {
                    newExerciseInput.value = '';
                    updateExerciseOptions(); // Actualizar el desplegable de ejercicios
                }).catch(error => {
                    console.error("Error adding exercise:", error);
                });
            }
        }

        muscleGroupSelect.addEventListener("change", updateExerciseOptions);
        saveExerciseButton.addEventListener("click", saveExercise);
        addMuscleGroupButton.addEventListener("click", addMuscleGroup);
        addExerciseButton.addEventListener("click", addExercise);
    </script>
</body>
</html>