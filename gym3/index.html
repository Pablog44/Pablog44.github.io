<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Marcas en el Gimnasio</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js"></script>
</head>
<body>
    <header>
        <h1>Registro de Marcas en el Gimnasio</h1>
    </header>
    <main>
        <section id="form-section">
            <div class="form-container">
                <label for="muscle-group">Grupo Muscular:</label>
                <select id="muscle-group"></select>
                <label for="exercise">Ejercicio:</label>
                <select id="exercise"></select>
                <label for="weight">Peso (kg):</label>
                <input type="number" id="weight" min="0" step="1">
                <label for="repetitions">Repeticiones:</label>
                <input type="number" id="repetitions" min="0" step="1">
                <label for="exercise-date">Fecha:</label>
                <input type="datetime-local" id="exercise-date">
                <button id="save-exercise">Guardar Ejercicio</button>
            </div>
        </section>
        <section id="custom-section">
            <div class="form-container">
                <h2>A침adir Nuevos Grupos/Ejercicios</h2>
                <label for="new-muscle-group">Nuevo Grupo Muscular:</label>
                <input type="text" id="new-muscle-group">
                <button id="add-muscle-group">A침adir Grupo Muscular</button>
                <label for="new-exercise">Nuevo Ejercicio:</label>
                <input type="text" id="new-exercise">
                <button id="add-exercise">A침adir Ejercicio</button>
            </div>
        </section>
        <section id="records-section">
            <h2>Historial de Ejercicios</h2>
            <ul id="exercise-records"></ul>
        </section>
    </main>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, addDoc, setDoc, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8sWu3ZG6NWvlEKQHRi23c7CgPPy_6yag",
            authDomain: "apuntagym.firebaseapp.com",
            projectId: "apuntagym",
            storageBucket: "apuntagym.appspot.com",
            messagingSenderId: "522093591127",
            appId: "1:522093591127:web:27e2e56085d50c85b18112",
            measurementId: "G-PY9MT94G92"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'inicio.html'; // Redirige si no est치 autenticado
            } else {
                initializeMuscleGroups();
                displayExerciseRecords();
            }
        });

        function initializeMuscleGroups() {
            const groupsRef = collection(db, "muscleGroups");
            getDocs(groupsRef).then(snapshot => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.textContent = doc.id; // Asumiendo que el id del documento es el nombre del grupo muscular
                    muscleGroupSelect.appendChild(option);
                });
                updateExerciseOptions(); // Carga inicial de ejercicios
            }).catch(error => {
                console.error("Error loading muscle groups: ", error);
            });
        }

        function updateExerciseOptions() {
            const selectedGroup = muscleGroupSelect.value;
            const exercisesRef = doc(db, "muscleGroups", selectedGroup);
            getDocs(collection(db, "exercises", exercisesRef.id)).then(snapshot => {
                exerciseSelect.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement("option");
                    option.value = data.name;
                    option.textContent = data.name; // Asumiendo que 'name' es el campo del nombre del ejercicio
                    exerciseSelect.appendChild(option);
                });
            }).catch(error => {
                console.error("Error loading exercises: ", error);
            });
        }

        function saveExercise() {
            const muscleGroup = muscleGroupSelect.value;
            const exercise = exerciseSelect.value;
            const weight = weightInput.value;
            const repetitions = repetitionsInput.value;
            const dateTime = exerciseDateInput.value || new Date().toISOString();
            addDoc(collection(db, "exerciseRecords"), {
                muscleGroup,
                exercise,
                weight,
                repetitions,
                dateTime
            }).then(() => {
                displayExerciseRecords();
                clearForm();
            }).catch(error => {
                console.error("Error saving exercise: ", error);
            });
        }

        function displayExerciseRecords() {
            getDocs(query(collection(db, "exerciseRecords"), orderBy("dateTime"))).then(snapshot => {
                exerciseRecordsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const listItem = document.createElement("li");
                    listItem.innerHTML = `${data.dateTime} - ${data.muscleGroup}: ${data.exercise} (${data.weight} kg x ${data.repetitions} reps)
                        <button onclick="deleteRecord('${doc.id}')">Eliminar</button>`;
                    exerciseRecordsList.appendChild(listItem);
                });
            }).catch(error => {
                console.error("Error displaying records: ", error);
            });
        }

        function deleteRecord(docId) {
            deleteDoc(doc(db, "exerciseRecords", docId)).then(() => {
                displayExerciseRecords();
            }).catch(error => {
                console.error("Error deleting record: ", error);
            });
        }

        function clearForm() {
            weightInput.value = '';
            repetitionsInput.value = '';
            exerciseDateInput.value = '';
        }

        muscleGroupSelect.addEventListener("change", updateExerciseOptions);
        saveExerciseButton.addEventListener("click", saveExercise);
        addMuscleGroupButton.addEventListener("click", addMuscleGroup);
        addExerciseButton.addEventListener("click", addExercise);
    </script>
</body>
</html>
